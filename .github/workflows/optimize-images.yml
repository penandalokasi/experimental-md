      - name: Optimize media
        run: |
          mkdir -p images-optimized

          for file in images/*; do
            [ -f "$file" ] || continue

            filename=$(basename "$file")
            name="${filename%.*}"
            ext="${filename##*.}"
            ext_lower=$(echo "$ext" | tr '[:upper:]' '[:lower:]')

            case "$ext_lower" in

              # JPG / PNG → WebP
              jpg|jpeg|png)
                output="images-optimized/$name.webp"

                if [ -f "$output" ]; then
                  if [ "$file" -ot "$output" ]; then
                    echo "Skipping $filename (WebP up to date)"
                    continue
                  else
                    echo "Reprocessing $filename (updated)"
                  fi
                else
                  echo "Processing $filename (new)"
                fi

                convert "$file[0]" \
                  -strip \
                  -resize 1600x1600\> \
                  -quality 80 \
                  "$output"
                ;;

              # GIF → WebM
              gif)
                output="images-optimized/$name.webm"

                if [ -f "$output" ]; then
                  # Skip if output is newer than source
                  if [ "$file" -ot "$output" ]; then
                    echo "Skipping $filename (WebM up to date)"
                    continue
                  else
                    echo "Reprocessing $filename (updated)"
                  fi
                else
                  echo "Processing GIF $filename (new)"
                fi

                ffmpeg -y -loglevel error -i "$file" \
                  -vf "scale=1600:-2:flags=lanczos,fps=15" \
                  -c:v libvpx-vp9 \
                  -b:v 0 \
                  -crf 35 \
                  -an \
                  -loop 0 \
                  "$output"
                ;;

              *)
                echo "Skipping $filename (unsupported)"
                ;;
            esac
          done


      - name: Generate index.json
        run: |
          echo "Generating index.json"

          output="images-optimized/index.json"
          echo "[" > "$output"

          first=true

          # Sort originals by filename descending (newest first)
          for file in $(ls -1 images | sort -r); do
            name="${file%.*}"
            ext="${file##*.}"
            ext_lower=$(echo "$ext" | tr '[:upper:]' '[:lower:]')

            case "$ext_lower" in
              jpg|jpeg|png)
                optimized="$name.webp"
                ;;
              gif)
                optimized="$name.webm"
                ;;
              *)
                continue
                ;;
            esac

            # Skip if optimized file doesn't exist (safety)
            if [ ! -f "images-optimized/$optimized" ]; then
              continue
            fi

            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> "$output"
            fi

            echo "  {" >> "$output"
            echo "    \"optimized\": \"$optimized\"," >> "$output"
            echo "    \"original\": \"$file\"" >> "$output"
            echo "  }" >> "$output"

          done

          echo "]" >> "$output"


      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add images-optimized

          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "Update optimized media and index"
            git push
          fi
